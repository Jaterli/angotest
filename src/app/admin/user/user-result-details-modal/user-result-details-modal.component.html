<app-modal
  [isOpen]="isOpen"
  [title]="selectedResult()?.title || 'Detalles del Resultado'"
  [showCancelButton]="false"
  confirmText="Cerrar"
  (confirm)="closeModal()"
  [customContent]="true"
  [size]="'lg'">
  
  <div class="space-y-6 max-h-[70vh] overflow-y-auto">
    @if (isLoading()) {
      <div class="flex flex-col items-center justify-center py-8">
        <div class="w-8 h-8 border-3 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">Cargando detalles...</p>
      </div>
    }
    
    @if (error && !isLoading()) {
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 dark:text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <p class="text-red-700 dark:text-red-300 text-sm">{{ error }}</p>
        </div>
      </div>
    }
    
    @if (resultDetails() && !isLoading()) {
      <!-- Información del test -->
      <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Información del Test</h4>
            <div class="space-y-2">
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Tema Principal:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 ml-2">
                  {{ resultDetails().test.main_topic }}
                </span>
              </div>
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Subtema:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 ml-2">
                  {{ resultDetails().test.sub_topic }}
                </span>
              </div>
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Nivel:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 ml-2">
                  {{ resultDetails().test.level }}
                </span>
              </div>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estadísticas</h4>
            <div class="space-y-2">
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Puntuación:</span>
                <span [class]="'text-sm font-bold ml-2 ' + getScoreColor(resultDetails().score_details.score_percentage)">
                  {{ resultDetails().score_details.score_percentage | number:'1.1-1' }}%
                </span>
              </div>
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Correctas/Incorrectas:</span>
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100 ml-2">
                  <span class="text-emerald-600 dark:text-emerald-400">{{ resultDetails().score_details.correct }}</span> /
                  <span class="text-red-600 dark:text-red-400">{{ resultDetails().score_details.wrong }}</span>
                </span>
              </div>
              <div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Estado:</span>
                <span class="text-sm font-medium ml-2" [class]="getStatusColor(resultDetails().result.status)">
                  {{ getStatusLabel(resultDetails().result.status) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Preguntas y respuestas -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
          Preguntas ({{ resultDetails().questions.length }})
        </h4>
        
        <div class="space-y-4">
          @for (question of resultDetails().questions; track question.id; let i = $index) {
            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4"
                 [class]="question.is_correct 
                   ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-800/30'
                   : 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-800/30'">
              
              <!-- Header de la pregunta -->
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div [class]="'w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ' + 
                                (question.is_correct 
                                  ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300' 
                                  : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300')">
                    {{ i + 1 }}
                  </div>
                  <div class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    {{ question.question_text }}
                  </div>
                </div>
                <span [class]="'px-2 py-1 text-xs font-medium rounded-full ' + 
                              (question.is_correct 
                                ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300' 
                                : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300')">
                  {{ question.is_correct ? 'Correcta' : 'Incorrecta' }}
                </span>
              </div>
              
              <!-- Respuestas -->
              <div class="space-y-2">
                @for (answer of question.answers; track answer.id) {
                  <div class="flex items-center space-x-3 p-2 rounded-lg"
                       [class]="getAnswerClasses(answer, question.user_answer_id, question.correct_answer_id)">
                    
                    <!-- Indicador de selección -->
                    @if (answer.id === question.user_answer_id) {
                      <div class="flex-shrink-0">
                        <div class="w-4 h-4 rounded-full border-2" [class]="question.is_correct 
                          ? 'border-emerald-500 bg-emerald-500' 
                          : 'border-red-500 bg-red-500'">
                        </div>
                      </div>
                    } @else {
                      <div class="flex-shrink-0">
                        <div class="w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600"></div>
                      </div>
                    }
                    
                    <!-- Texto de la respuesta -->
                    <div class="flex-1">
                      <span class="text-sm" [class]="getAnswerTextClasses(answer, question.user_answer_id, question.correct_answer_id)">
                        {{ answer.answer_text }}
                      </span>
                    </div>
                    
                    <!-- Indicador de correcta -->
                    @if (answer.is_correct) {
                      <div class="flex-shrink-0">
                        <svg class="w-4 h-4 text-emerald-500 dark:text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                      </div>
                    }
                  </div>
                }
              </div>
              
              <!-- Explicación -->
              @if (!question.is_correct) {
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                  <div class="text-xs text-gray-600 dark:text-gray-400">
                    <span class="font-medium">Respuesta correcta:</span> 
                    {{ getCorrectAnswerText(question) }}
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
</app-modal>