<div class="container mx-auto p-4 md:p-6 lg:p-8">
  
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Mi Dashboard</h1>
      <p class="text-gray-600 dark:text-gray-400 mt-2">
        {{ currentUser?.first_name || currentUser?.username }}, 
        aqu铆 puedes ver tu progreso y compararte con otros usuarios
      </p>
    </div>

    <!-- Bot贸n para refrescar -->
    <button (click)="refreshAllData()"
            [disabled]="loading()"
            class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
      <svg [class]="loading() ? 'animate-spin' : ''" 
           class="w-4 h-4 mr-2" 
           fill="currentColor" 
           viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566a1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566a1 1 0 01.61-1.276z" clip-rule="evenodd"/>
      </svg>
      {{ loading() ? 'Actualizando...' : 'Actualizar Datos' }}
    </button>
  </div>

  <!-- Estado de carga -->
  @if (loading() && !dashboardData()) {
    <div class="flex flex-col items-center justify-center min-h-[400px] space-y-4">
      <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-gray-600 dark:text-gray-400 text-lg">Cargando dashboard...</p>
    </div>
  }

  <!-- Contenido principal -->
  @if (dashboardData() && !loading()) {    
    <!-- Secci贸n: Estad铆sticas del Usuario -->
    <div class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Tus Estad铆sticas</h2>
        
        <!-- Selector de intentos -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400 mr-2">Mostrar:</span>
          <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
            <button (click)="setAttemptType('first_attempt')"
                    [class]="attemptType() === 'first_attempt' 
                      ? 'px-3 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-gray-700 shadow-sm' 
                      : 'px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300'">
              Primer Intento
            </button>
            <button (click)="setAttemptType('all_attempts')"
                    [class]="attemptType() === 'all_attempts' 
                      ? 'px-3 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-gray-700 shadow-sm' 
                      : 'px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300'">
              Todos los Intentos
            </button>
          </div>
        </div>
      </div>

      <!-- Cards de estad铆sticas principales -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        
        <!-- Tests Completados -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="flex items-center mb-4">
            <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg mr-4">
              <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ personalData()!.completed_tests }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Tests completados</div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="text-center p-2 bg-gray-50 dark:bg-gray-900/50 rounded">
              <div class="text-lg font-semibold text-blue-600 dark:text-blue-400">
                {{ personalData()!.in_progress_tests }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">En progreso</div>
            </div>
            <div class="text-center p-2 bg-gray-50 dark:bg-gray-900/50 rounded">
              <div class="text-lg font-semibold text-gray-700 dark:text-gray-300">
                {{ totalUserTests() }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Total tests</div>
            </div>
          </div>
        </div>

        <!-- Precisi贸n -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="flex items-center mb-4">
            <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg mr-4">
              <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ currentAccuracy() | number:'1.0-2' }}%
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Precisi贸n {{ attemptType() === 'first_attempt' ? '1er intento' : 'general' }}</div>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 dark:text-gray-400">Preguntas:</span>
              <span class="font-medium text-emerald-600 dark:text-emerald-400">
                {{ currentAttemptData()?.total_questions_answered || 0 }}
              </span>
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 dark:text-gray-400">Correctas:</span>
              <span class="font-medium text-emerald-600 dark:text-emerald-400">
                {{ currentAttemptData()?.total_correct || 0 }}
              </span>
            </div>
          </div>
        </div>

        <!-- Tiempo -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="flex items-center mb-4">
            <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg mr-4">
              <svg class="w-6 h-6 text-amber-600 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ formatTimeShort(currentAverageTimePerQuestion()) }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Tiempo/pregunta</div>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 dark:text-gray-400">Total tiempo:</span>
              <span class="font-medium text-blue-600 dark:text-blue-400">
                {{ formatTime(currentAttemptData()?.total_time_taken || 0) }}
              </span>
            </div>
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 dark:text-gray-400">Tests realizados:</span>
              <span class="font-medium text-blue-600 dark:text-blue-400">
                {{ currentAttemptData()?.tests_count || 0 }}
              </span>
            </div>
          </div>
        </div>

        <!-- Rendimiento -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="flex items-center mb-4">
            <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg mr-4">
              <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ currentAttemptData()?.total_correct || 0 }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Respuestas correctas</div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="text-center p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded">
              <div class="text-sm font-semibold text-emerald-700 dark:text-emerald-400">
                {{ currentAttemptData()?.total_correct || 0 }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Correctas</div>
            </div>
            
            <div class="text-center p-2 bg-red-50 dark:bg-red-900/20 rounded">
              <div class="text-sm font-semibold text-red-700 dark:text-red-400">
                {{ currentAttemptData()?.total_wrong || 0 }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Incorrectas</div>
            </div>
          </div>
          
        </div>
      </div>

      <!-- Secci贸n: Mejoras entre intentos -->
      @if (improvementData()) {
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Mejoras con Repetici贸n</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
            <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
              {{ improvementData()!.accuracy_improvement >= 0 ? '+' : '' }}{{ improvementData()!.accuracy_improvement.toFixed(2) }}%
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Mejora en precisi贸n</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ getImprovementSymbol(improvementData()!.accuracy_improvement, 'accuracy') }}
              {{ getImprovementText(improvementData()!.accuracy_improvement, 'accuracy') }}
            </div>
          </div>
          
          <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
              {{ improvementData()!.time_improvement >= 0 ? '+' : '' }}{{ improvementData()!.time_improvement.toFixed(1) }}s
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Mejora en tiempo/pregunta</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ getImprovementSymbol(improvementData()!.time_improvement, 'time') }}
              {{ getImprovementText(improvementData()!.time_improvement, 'time') }}
            </div>
          </div>
          
          <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">
              +{{ improvementData()!.questions_improvement }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Preguntas adicionales</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Con repetici贸n para mejorar
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Secci贸n: Niveles -->
      @if (levelStatsByAttempt().length > 0) {
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Desempe帽o por Nivel</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          @for (level of levelStatsByAttempt(); track level.level) {
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" 
                    [style.backgroundColor]="getLevelColor(level.level) + '20'">
                  <span class="text-sm">{{ getLevelIcon(level.level) }}</span>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900 dark:text-gray-100">{{ level.level }}</h4>
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{ level.tests_count }} tests</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold" [style.color]="getLevelColor(level.level)">
                  {{ level.accuracy.toFixed(2) }}%
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Precisi贸n</div>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600 dark:text-gray-400">Preguntas:</span>
                <span class="font-medium" [style.color]="getLevelColor(level.level)">
                  {{ level.questions_count }}
                </span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600 dark:text-gray-400">Tiempo/preg:</span>
                <span class="font-medium" [style.color]="getLevelColor(level.level)">
                  {{ formatTimeShort(level.avg_time_per_question) }}
                </span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="text-center p-1 bg-emerald-50 dark:bg-emerald-900/20 rounded">
                  <div class="font-medium text-emerald-600 dark:text-emerald-400">{{ level.total_correct }}</div>
                  <div class="text-gray-500 dark:text-gray-400">Correctas</div>
                </div>
                <div class="text-center p-1 bg-red-50 dark:bg-red-900/20 rounded">
                  <div class="font-medium text-red-600 dark:text-red-400">{{ level.total_wrong }}</div>
                  <div class="text-gray-500 dark:text-gray-400">Incorrectas</div>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Secci贸n: Rankings (solo se muestra al hacer click) -->
    @if (!showRankings()) {
    <div class="mb-12">
      <div class="bg-white dark:bg-gray-800 rounded-xl p-8 text-center shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="w-20 h-20 text-blue-300 dark:text-blue-600 mx-auto mb-4">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">Compara tu rendimiento</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
          Descubre c贸mo te comparas con otros {{ dashboardData()?.total_active_users || 0 }} usuarios activos en la comunidad. 
          Verifica tu posici贸n en los rankings y analiza tu rendimiento frente al promedio.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">          
          
          @if (personalData()!.completed_tests < 5) {
          <div class="text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">
            锔 Necesitas completar al menos <strong>5 tests</strong> para ver tu posici贸n en los rankings.  
          </div>
          } @else {

            <button (click)="loadRankings()"
                    [disabled]="rankingsLoading()"
                    class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg text-white bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <svg [class]="rankingsLoading() ? 'animate-spin' : ''" 
                    class="w-5 h-5 mr-2" 
                    fill="currentColor" 
                    viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              {{ rankingsLoading() ? 'Cargando...' : 'Ver Rankings y Posici贸n' }}
            </button>
          }
          
        </div>
      </div>
    </div>
    }

    <!-- Secci贸n: Rankings (cuando se muestran) -->
    @if (showRankings() && rankingsData()) {
    <div class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Rankings y Posici贸n en la Comunidad</h2>
        <button (click)="hideRankings()"
                class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
          Ocultar Rankings
        </button>
      </div>
      
      <!-- Tu posici贸n global -->
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4"> Tu Posici贸n Global comparada con {{ currentUserPositions()?.total_active_users || 0 }} usuarios activos</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tests Completados</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.completed_tests || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ personalData()?.completed_tests || 0 }} tests realizados
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precisi贸n General</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.all_attempts?.accuracy || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ currentAccuracyAllAttempts() | number:'1.0-1' }}% todos los intentos
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Precisi贸n 1er Intento</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.first_attempt?.accuracy || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ currentAccuracyFirstAttempt() | number:'1.0-1' }}% primer intento
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Preguntas Respondidas</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.all_attempts?.questions_answered || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ personalData()!.all_attempts.total_questions_answered || 0 }} preguntas
            </div>
          </div>
        
          <!-- Posiciones de tiempo -->
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tiempo/pregunta General</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.all_attempts?.avg_time_taken_per_question || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ formatTimeShort(currentAverageTimePerQuestionAllAttempts()) }} todos los intentos
            </div>
          </div>
          
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
            <div class="mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tiempo/pregunta 1er Intento</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">
              #{{ currentUserPositions()?.first_attempt?.avg_time_taken_per_question || '-' }}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              {{ formatTimeShort(currentAverageTimePerQuestionFirstAttempt()) }} primer intento
            </div>
          </div>
        </div>
        
        <!-- Resumen comparativo -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="text-center p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
              <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mejora en Precisi贸n</div>
              @if (improvementData()) {
              <div class="text-xl font-bold text-emerald-600 dark:text-emerald-400">
                {{ improvementData()!.accuracy_improvement >= 0 ? '+' : '' }}{{ improvementData()!.accuracy_improvement.toFixed(2) }}%
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                1er intento vs todos los intentos
              </div>
              } @else {
              <div class="text-xl font-bold text-gray-400 dark:text-gray-500">0.0%</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                1er intento vs todos los intentos
              </div>
              }
            </div>
            
            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mejora en Tiempo</div>
              @if (improvementData()) {
              <div class="text-xl font-bold text-blue-600 dark:text-blue-400">
                {{ improvementData()!.time_improvement >= 0 ? '+' : '' }}{{ improvementData()!.time_improvement.toFixed(2) }}s
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                1er intento vs todos los intentos
              </div>
              } @else {
              <div class="text-xl font-bold text-gray-400 dark:text-gray-500">0.0s</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                1er intento vs todos los intentos
              </div>
              }
            </div>
          </div>
        </div>        
      </div>
      
      <!-- Top Rankings -->
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100"> Top Rankings Globales</h3>
          <div class="text-xs px-3 py-1 bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300 rounded-full">
            M铆nimo {{ rankingsData()?.min_tests_for_ranking }} tests para ranking
          </div>
        </div>
        
        <!-- Tabs de rankings -->
        <div class="mb-4">
          <div class="flex flex-wrap gap-2">
            @for (tab of ['tests', 'time_all', 'time_first', 'accuracy_all', 'accuracy_first', 'questions_all', 'questions_first']; track tab) {
            <button (click)="setRankingTab(tab)"
                    [class]="activeRankingTab() === tab 
                    ? 'px-3 py-1.5 text-xs font-medium rounded-full border' 
                    : 'px-3 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-900/50 hover:bg-gray-200 dark:hover:bg-gray-900/70 rounded-full transition-colors'"
                    [style.borderColor]="activeRankingTab() === tab ? getRankingTabColor(tab) : 'transparent'"
                    [style.color]="activeRankingTab() === tab ? getRankingTabColor(tab) : ''">
              {{ getRankingTabLabel(tab).split(' ')[0] }}
            </button>
            }
          </div>
        </div>
        
        <!-- Indicador de tipo de ranking actual -->
        <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ getRankingTabLabel(activeRankingTab()) }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                {{ getRankingDescription(activeRankingTab()) }}
              </div>
            </div>
            <!-- Tu posici贸n en este ranking -->
            <div class="text-right">
              <div class="text-sm font-bold text-blue-600 dark:text-blue-400">
                Tu posici贸n: #{{ getCurrentUserPosition(activeRankingTab()) || '-' }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                de {{ currentUserPositions()?.total_active_users || 0 }} usuarios
              </div>
            </div>
          </div>
        </div>
        
        <!-- Lista de top 5 -->
        <div class="space-y-3 mb-6">
          @for (item of currentRankings(); track item.user_id; let i = $index) {
          <div [class]="getRankingItemClass(i, item.user_id)" class="rounded-lg p-3 transition-colors">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3"
                    [ngClass]="{
                      'bg-amber-100 dark:bg-amber-900/30': i === 0,
                      'bg-gray-100 dark:bg-gray-900/50': i === 1,
                      'bg-amber-50 dark:bg-amber-900/20': i === 2,
                      'bg-gray-50 dark:bg-gray-900/30': i > 2
                    }">
                  <span [ngClass]="{
                    'text-amber-600 dark:text-amber-400 font-bold': i === 0,
                    'text-gray-600 dark:text-gray-400 font-bold': i === 1,
                    'text-amber-500 dark:text-amber-300 font-bold': i === 2,
                    'text-gray-500 dark:text-gray-400': i > 2
                  }">
                    {{ item.rank }}
                  </span>
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-gray-100 text-sm">
                    {{ item.username }}
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    Posici贸n {{ item.rank }} de {{ currentUserPositions()?.total_active_users || 0 }}
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div class="font-bold text-gray-900 dark:text-gray-100">
                  {{ formatRankingValue(item.value, getRankingTabLabel(activeRankingTab())) }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  {{ getRankingUnit(activeRankingTab()) }}
                </div>
              </div>
            </div>
          </div>
          }
        </div>
        
        <!-- Tu dato actual en este ranking -->
        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                <span class="text-blue-600 dark:text-blue-400 font-bold text-sm">
                  #{{ getCurrentUserPosition(activeRankingTab()) || '-' }}
                </span>
              </div>
              <div>
                <div class="font-medium text-gray-900 dark:text-gray-100 text-sm">{{ currentUser?.username }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Tu posici贸n actual</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-blue-600 dark:text-blue-400">
                {{ getCurrentUserValue(activeRankingTab()) }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                Tu {{ getRankingTabLabel(activeRankingTab()).toLowerCase() }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rankings por Nivel (Precisi贸n) -->
      @if (getLevelKeys().length > 0) {
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 mt-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100"> Rankings de precisi贸n por Nivel</h3>
          <div class="text-xs px-3 py-1 bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300 rounded-full">
            Primer intento por nivel. (M铆nimo {{ rankingsData()?.min_tests_for_ranking }} tests para ranking)
          </div>
        </div>
        
        <!-- Tabs de niveles (se mantiene el mismo que arriba) -->
        <div class="mb-4">
          <div class="flex flex-wrap gap-2">
            @for (level of getLevelKeys(); track level) {
            <button (click)="setLevelRankingTab(level)"
                    [class]="activeLevelRankingTab() === level 
                    ? 'px-3 py-1.5 text-xs font-medium rounded-full border' 
                    : 'px-3 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-900/50 hover:bg-gray-200 dark:hover:bg-gray-900/70 rounded-full transition-colors'"
                    [style.borderColor]="activeLevelRankingTab() === level ? getLevelColor(level) : 'transparent'"
                    [style.color]="activeLevelRankingTab() === level ? getLevelColor(level) : ''">
              {{ level }}
            </button>
            }
          </div>
        </div>
        
        <!-- Indicador de nivel actual -->
        <div class="mb-4 p-3 rounded-lg" [style.backgroundColor]="getLevelColor(activeLevelRankingTab()) + '20'">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" 
                  [style.backgroundColor]="getLevelColor(activeLevelRankingTab()) + '30'">
                <span class="text-sm">{{ getLevelIcon(activeLevelRankingTab()) }}</span>
              </div>
              <div>
                <div class="text-sm font-medium" [style.color]="getLevelColor(activeLevelRankingTab())">
                  Nivel {{ activeLevelRankingTab() }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  Ranking basado en precisi贸n (primer intento)
                </div>
              </div>
            </div>
            <!-- Tu posici贸n en precisi贸n para este nivel -->
            <div class="text-right">
              <div class="text-sm font-bold" [style.color]="getLevelColor(activeLevelRankingTab())">
                Tu posici贸n: #{{ getMyLevelAccuracyPosition(activeLevelRankingTab()) || '-' }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                de {{ currentUserPositions()?.total_active_users || 0 }} usuarios
              </div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Top 5 del nivel en precisi贸n -->
          <div>
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Top 5 Precisi贸n - {{ activeLevelRankingTab() }}</h4>
            <div class="space-y-3">
              @for (item of currentLevelRankingsAccuracy(); track item.user_id; let i = $index) {
              <div [class]="getRankingItemClass(i, item.user_id)" class="rounded-lg p-3 transition-colors">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3"
                        [style.backgroundColor]="getLevelColor(activeLevelRankingTab()) + '20'">
                      <span class="font-bold text-sm" [style.color]="getLevelColor(activeLevelRankingTab())">
                        {{ item.rank }}
                      </span>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900 dark:text-gray-100 text-sm">
                        {{ item.username }}
                      </div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">
                        Posici贸n {{ item.rank }}
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-gray-900 dark:text-gray-100">{{ item.value.toFixed(2) }}%</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">precisi贸n 1er intento</div>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
          
          <!-- Tu posici贸n y precisi贸n en este nivel -->
          <div>
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Tu precisi贸n en {{ activeLevelRankingTab() }}</h4>
            <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3"
                      [style.backgroundColor]="getLevelColor(activeLevelRankingTab()) + '30'">
                    <span class="font-bold" [style.color]="getLevelColor(activeLevelRankingTab())">
                      #{{ getMyLevelAccuracyPosition(activeLevelRankingTab()) || '-' }}
                    </span>
                  </div>
                  <div>
                    <div class="font-medium text-gray-900 dark:text-gray-100">{{ currentUser?.username }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Tu posici贸n en precisi贸n</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-bold" [style.color]="getLevelColor(activeLevelRankingTab())">
                    {{ getLevelAccuracyValue(activeLevelRankingTab()) }}%
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">tu precisi贸n 1er intento</div>
                </div>
              </div>
              
              <!-- Tus estad铆sticas de precisi贸n -->
              <div class="grid grid-cols-2 gap-3 mt-4">
                <div class="text-center p-2 bg-white dark:bg-gray-800 rounded">
                  <div class="text-sm font-medium" [style.color]="getLevelColor(activeLevelRankingTab())">
                    {{ getLevelTestCount(activeLevelRankingTab()) }}
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Tests completados</div>
                </div>
                <div class="text-center p-2 bg-white dark:bg-gray-800 rounded">
                  <div class="text-sm font-medium" [style.color]="getLevelColor(activeLevelRankingTab())">
                    {{ getLevelQuestionsCount(activeLevelRankingTab()) }}
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Preguntas respondidas</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      }
      
    </div>
    }

    <!-- Acciones R谩pidas -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
      <a routerLink="/tests/not-started"
         class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md dark:hover:shadow-gray-900/30 transition-all text-center group">
        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-200 dark:group-hover:bg-blue-900/50 transition-colors">
          <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-1">Nuevo Test</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400">Realiza un nuevo desaf铆o</p>
      </a>
      
      <a routerLink="/tests/completed"
         class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md dark:hover:shadow-gray-900/30 transition-all text-center group">
        <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center mx-auto mb-3 group-hover:bg-emerald-200 dark:group-hover:bg-emerald-900/50 transition-colors">
          <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-1">Ver Resultados</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400">Revisa tests completados</p>
      </a>
      
      <a routerLink="/tests/in-progress"
         class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md dark:hover:shadow-gray-900/30 transition-all text-center group">
        <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center mx-auto mb-3 group-hover:bg-amber-200 dark:group-hover:bg-amber-900/50 transition-colors">
          <svg class="w-6 h-6 text-amber-600 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-1">Continuar Tests</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400">Termina tests en progreso</p>
      </a>
    </div>
  }

  <!-- Error state -->
  @if (error() && !dashboardData()) {
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg dark:shadow-gray-900/30 border border-gray-200 dark:border-gray-700 p-8 text-center">
      <div class="w-20 h-20 text-red-300 dark:text-red-600 mx-auto mb-4">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">Error al cargar el dashboard</h3>
      <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-6">
        {{ error() }}
      </p>
      <button (click)="loadDashboardData()"
              class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
        Intentar de nuevo
      </button>
    </div>
  }
</div>